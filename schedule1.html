<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#1a1a1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ">
<title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∫–æ–ª–ª–µ–¥–∂–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Geologica:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#141414;--surface:#1e1e1e;--surface2:#272727;--surface3:#323232;
  --accent:#e87722;--accent2:#c45f0a;--text:#f0ede8;--muted:#7a7774;
  --success:#5ba05b;--danger:#d95f5f;--r:12px;--rb:8px;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px)}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Geologica',sans-serif;overflow:hidden}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;
  padding-top:var(--safe-top);padding-bottom:var(--safe-bot);overflow:hidden;
  opacity:0;pointer-events:none;transform:translateY(24px);
  transition:opacity .28s cubic-bezier(.4,0,.2,1),transform .28s cubic-bezier(.4,0,.2,1)}
.screen.active{opacity:1;pointer-events:all;transform:none}
.screen.exit-left{opacity:0;transform:translateX(-40px)}
.screen.exit-right{opacity:0;transform:translateX(40px)}
.body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 20px}
.body::-webkit-scrollbar{display:none}
.hdr{padding:16px 20px 12px;display:flex;align-items:center;gap:12px;
  border-bottom:1px solid var(--surface3);flex-shrink:0}
.hdr-back{background:var(--surface2);border:none;color:var(--accent);
  width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:20px;
  display:flex;align-items:center;justify-content:center;transition:background .15s}
.hdr-back:active{background:var(--surface3)}
.hdr-title{font-size:17px;font-weight:600;flex:1}
.hdr-sub{font-size:12px;color:var(--muted);margin-top:1px}
#s-home .logo-area{padding:36px 20px 24px;text-align:center}
#s-home .logo-sub{font-size:11px;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-bottom:6px}
#s-home .logo-main{font-size:34px;font-weight:700;color:var(--accent);letter-spacing:-.02em}
.section-label{font-size:10px;font-weight:600;color:var(--muted);
  letter-spacing:.12em;text-transform:uppercase;margin-bottom:8px;margin-top:4px}
.inp{width:100%;background:var(--surface2);border:1px solid var(--surface3);
  border-radius:var(--rb);color:var(--text);font-family:inherit;
  font-size:14px;padding:13px 14px;outline:none;transition:border-color .15s}
.inp:focus{border-color:var(--accent)}
.inp::placeholder{color:var(--muted)}
.btn{width:100%;border:none;border-radius:var(--rb);font-family:inherit;
  font-size:14px;font-weight:600;padding:15px;cursor:pointer;
  transition:opacity .12s,transform .1s;
  display:flex;align-items:center;justify-content:center;gap:8px}
.btn:active{opacity:.8;transform:scale(.98)}
.btn-accent{background:var(--accent);color:#fff}
.btn-accent2{background:var(--accent2);color:#fff}
.btn-surface{background:var(--surface2);color:var(--text)}
.btn-surface3{background:var(--surface3);color:var(--accent)}
.btn-success{background:var(--success);color:#fff}
.status{font-size:12px;color:var(--muted);text-align:center;min-height:18px}
.progress{height:2px;background:var(--surface3);border-radius:1px;overflow:hidden;margin:4px 0}
.progress-bar{height:100%;background:var(--accent);width:0;border-radius:1px;transition:width .3s}
.sep{height:1px;background:var(--surface3);margin:12px 0}
.list{display:flex;flex-direction:column;gap:8px}
.list-item{background:var(--surface2);border-radius:var(--rb);padding:14px 16px;
  cursor:pointer;transition:background .12s;
  display:flex;align-items:center;justify-content:space-between;font-size:14px}
.list-item:active{background:var(--surface3)}
.list-item.selected{background:var(--accent2);color:#fff}
.list-item .item-name{font-weight:600;flex:1}
.list-item .item-arrow{color:var(--muted);font-size:16px}
.search-wrap{position:relative}
.search-wrap .inp{padding-left:38px}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:15px}
.sched-header{padding:16px 20px;background:var(--surface);
  border-bottom:1px solid var(--surface3);flex-shrink:0}
.sched-group{font-size:22px;font-weight:700;color:var(--accent)}
.sched-date{font-size:12px;color:var(--muted);margin-top:2px}
.pair-card{background:var(--surface2);border-radius:var(--r);
  margin-bottom:10px;overflow:hidden;border-left:3px solid var(--surface3)}
.pair-card.has-subject{border-left-color:var(--accent2)}
.pair-card.is-now{border-left-color:var(--accent)}
.pair-top{display:flex;align-items:center;padding:12px 14px 8px;gap:12px}
.pair-num{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;
  color:var(--muted);min-width:28px;text-transform:uppercase}
.pair-subject{font-size:14px;font-weight:600;flex:1;line-height:1.3}
.pair-subject.empty{color:var(--muted);font-weight:400;font-style:italic}
/* ‚îÄ‚îÄ –î–≤–∞ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Å—Ç–∏–ª—å ‚îÄ‚îÄ */
.pair-times{padding:4px 14px 12px 54px;display:flex;flex-direction:column;gap:5px}
.pair-time-row{display:flex;align-items:center;gap:8px}
.pair-time-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;color:var(--text)}
.pair-time-tag{font-size:10px;font-weight:600;color:var(--muted);
  background:var(--surface3);padding:2px 6px;border-radius:4px;
  letter-spacing:.06em;text-transform:uppercase}
.pair-details{padding:0 14px 12px 54px;font-size:13px;color:var(--muted);line-height:1.5}
.now-badge{display:inline-block;background:var(--accent);color:#fff;
  font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;
  letter-spacing:.05em;text-transform:uppercase;margin-left:8px;vertical-align:middle}
.last-group-btn{background:var(--surface3);border:none;border-radius:var(--rb);
  color:var(--accent);font-family:inherit;font-size:14px;font-weight:700;
  padding:15px;width:100%;cursor:pointer;transition:opacity .12s,transform .1s;text-align:center}
.last-group-btn:active{opacity:.8;transform:scale(.98)}
.toast{position:fixed;bottom:calc(20px + var(--safe-bot));
  left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--surface3);color:var(--text);font-size:13px;
  padding:10px 18px;border-radius:100px;white-space:nowrap;
  transition:transform .3s cubic-bezier(.4,0,.2,1),opacity .3s;
  opacity:0;z-index:999;max-width:90vw;overflow:hidden;text-overflow:ellipsis}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
/* ‚îÄ‚îÄ –ó–≤–æ–Ω–∫–∏: –æ–±–µ —Å—Ç—Ä–æ–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ ‚îÄ‚îÄ */
.bell-day{font-size:12px;font-weight:700;color:var(--accent);
  letter-spacing:.1em;text-transform:uppercase;margin:16px 0 8px}
.bell-card{background:var(--surface2);border-radius:var(--rb);
  padding:14px;margin-bottom:8px;display:flex;align-items:flex-start;gap:14px}
.bell-num{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--muted);min-width:28px;padding-top:3px}
.bell-slots{display:flex;flex-direction:column;gap:8px;flex:1}
.bell-slot{display:flex;align-items:center;gap:10px}
.bell-slot-time{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;color:var(--text)}
.bell-slot-tag{font-size:10px;font-weight:600;color:var(--muted);
  background:var(--surface3);padding:2px 6px;border-radius:4px;
  letter-spacing:.06em;text-transform:uppercase}
.bottom-nav{display:flex;border-top:1px solid var(--surface3);flex-shrink:0;padding-bottom:var(--safe-bot)}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;
  padding:10px 0;cursor:pointer;color:var(--muted);
  transition:color .15s;font-size:10px;gap:3px;background:none;border:none;font-family:inherit}
.nav-item .nav-icon{font-size:22px}
.nav-item.active{color:var(--accent)}
.settings-row{display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;background:var(--surface2);border-radius:var(--rb);margin-bottom:8px;font-size:14px}
.toggle-switch{width:44px;height:24px;border-radius:100px;
  background:var(--surface3);position:relative;cursor:pointer;transition:background .2s;flex-shrink:0}
.toggle-switch.on{background:var(--accent)}
.toggle-switch::after{content:'';position:absolute;width:18px;height:18px;
  border-radius:50%;background:#fff;top:3px;left:3px;transition:left .2s}
.toggle-switch.on::after{left:23px}
.theme-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.theme-card{background:var(--surface2);border-radius:var(--rb);padding:12px;
  cursor:pointer;border:2px solid transparent;transition:border-color .15s;font-size:13px;font-weight:600}
.theme-card.selected{border-color:var(--accent)}
.theme-swatch{display:flex;gap:4px;margin-bottom:8px}
.swatch{width:16px;height:16px;border-radius:50%}
.hidden{display:none!important}
.mt8{margin-top:8px}.mt16{margin-top:16px}
</style>
</head>
<body>

<!-- –ì–õ–ê–í–ù–ê–Ø -->
<div class="screen active" id="s-home">
  <div class="body">
    <div class="logo-area">
      <div class="logo-sub">—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
      <div class="logo-main">–ö–æ–ª–ª–µ–¥–∂</div>
    </div>
    <div id="last-group-wrap" class="hidden">
      <div class="section-label">–ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫</div>
      <button class="last-group-btn" id="last-group-btn" onclick="jumpToLastGroup()"></button>
      <div style="height:12px"></div>
    </div>
    <div class="section-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫</div>
    <input class="inp" id="url-input" type="url" placeholder="https://disk.yandex.ru/d/..."
           autocomplete="off" autocorrect="off" autocapitalize="off">
    <div style="height:10px"></div>
    <button class="btn btn-accent2" onclick="loadFiles()">‚¨á –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤</button>
    <div style="height:6px"></div>
    <div class="status" id="home-status"></div>
    <div class="progress"><div class="progress-bar" id="home-bar"></div></div>
    <div id="file-section" class="hidden">
      <div class="sep"></div>
      <div class="section-label">–§–∞–π–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</div>
      <div class="list" id="file-list"></div>
      <div style="height:12px"></div>
      <button class="btn btn-success" onclick="goToGroups()">–í—ã–±—Ä–∞—Ç—å –≥—Ä—É–ø–ø—É ‚Üí</button>
    </div>
  </div>
  <div class="bottom-nav">
    <button class="nav-item active" id="nav-home" onclick="goHome()">
      <span class="nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-item" id="nav-bells" onclick="navTo('s-bells','nav-bells')">
      <span class="nav-icon">üîî</span><span>–ó–≤–æ–Ω–∫–∏</span></button>
    <button class="nav-item" id="nav-settings" onclick="navTo('s-settings','nav-settings')">
      <span class="nav-icon">‚öôÔ∏è</span><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  </div>
</div>

<!-- –ì–†–£–ü–ü–´ -->
<div class="screen" id="s-groups">
  <div class="hdr">
    <button class="hdr-back" onclick="goHome()">‚Äπ</button>
    <div><div class="hdr-title" id="groups-title">–í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã</div>
    <div class="hdr-sub" id="groups-sub"></div></div>
  </div>
  <div style="padding:12px 20px 0;flex-shrink:0">
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input class="inp" id="group-search" placeholder="–ù–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É..." oninput="filterGroups(this.value)">
    </div>
    <div class="status mt8" id="groups-status"></div>
    <div class="progress"><div class="progress-bar" id="groups-bar"></div></div>
  </div>
  <div class="body" style="padding-top:12px"><div class="list" id="group-list"></div></div>
</div>

<!-- –†–ê–°–ü–ò–°–ê–ù–ò–ï -->
<div class="screen" id="s-schedule">
  <div class="sched-header">
    <div style="display:flex;align-items:center;gap:10px">
      <button class="hdr-back" onclick="showScreen('s-groups','back')">‚Äπ</button>
      <div><div class="sched-group" id="sched-group-name"></div>
      <div class="sched-date" id="sched-date"></div></div>
    </div>
  </div>
  <div class="body" id="sched-body"></div>
</div>

<!-- –ó–í–û–ù–ö–ò -->
<div class="screen" id="s-bells">
  <div class="hdr">
    <button class="hdr-back" onclick="goHome()">‚Äπ</button>
    <div class="hdr-title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤</div>
  </div>
  <div class="body" id="bells-body"></div>
</div>

<!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
<div class="screen" id="s-settings">
  <div class="hdr">
    <button class="hdr-back" onclick="goHome()">‚Äπ</button>
    <div class="hdr-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
  <div class="body">
    <div class="section-label">–¢–µ–º–∞</div>
    <div class="theme-grid" id="theme-grid"></div>
    <div class="sep"></div>
    <div class="section-label">–ü—Ä–æ—á–µ–µ</div>
    <div class="settings-row">
      <div><div style="font-weight:500">–ó–∞–ø–æ–º–Ω–∏—Ç—å URL</div></div>
      <div class="toggle-switch on" id="toggle-save-url" onclick="toggleSetting('saveUrl')"></div>
    </div>
    <div style="height:8px"></div>
    <div class="status" id="proxy-status" style="text-align:left;font-size:11px"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê –¢–ï–ú–´ ‚ïê‚ïê
const THEMES={
  'orange':{name:'–ö–æ–ª–ª–µ–¥–∂',vars:{'--bg':'#141414','--surface':'#1e1e1e','--surface2':'#272727','--surface3':'#323232','--accent':'#e87722','--accent2':'#c45f0a','--text':'#f0ede8','--muted':'#7a7774'},sw:['#141414','#e87722','#c45f0a']},
  'win11':{name:'Windows 11',vars:{'--bg':'#202020','--surface':'#2c2c2c','--surface2':'#393939','--surface3':'#4a4a4a','--accent':'#74b9ff','--accent2':'#0067c0','--text':'#ffffff','--muted':'#9a9a9a'},sw:['#202020','#74b9ff','#0067c0']},
  'amoled':{name:'AMOLED',vars:{'--bg':'#000000','--surface':'#0a0a0a','--surface2':'#141414','--surface3':'#1f1f1f','--accent':'#00e5ff','--accent2':'#00acc1','--text':'#ffffff','--muted':'#606060'},sw:['#000000','#00e5ff','#00acc1']},
  'light':{name:'–°–≤–µ—Ç–ª–∞—è',vars:{'--bg':'#ffffff','--surface':'#f5f5f5','--surface2':'#ebebeb','--surface3':'#d8d8d8','--accent':'#0d6efd','--accent2':'#0a58ca','--text':'#111111','--muted':'#7a7a8c'},sw:['#f5f5f5','#0d6efd','#0a58ca']},
  'pixel':{name:'Material',vars:{'--bg':'#1a1c1e','--surface':'#25272a','--surface2':'#303337','--surface3':'#3c3f44','--accent':'#98c4ff','--accent2':'#2f71d4','--text':'#e3e5e8','--muted':'#8e9099'},sw:['#1a1c1e','#98c4ff','#2f71d4']},
  'aero':{name:'Aero Blue',vars:{'--bg':'#1b3a5c','--surface':'#1f4d7a','--surface2':'#276096','--surface3':'#3575ad','--accent':'#7fd7ff','--accent2':'#00a8e8','--text':'#f0faff','--muted':'#8bbfd8'},sw:['#1b3a5c','#7fd7ff','#00a8e8']},
};

// ‚ïê‚ïê –ó–í–û–ù–ö–ò ‚ïê‚ïê
const BELL_MON={'I':['09:00','09:45','09:50','10:35'],'II':['10:45','11:30','11:35','12:20'],'III':['12:50','13:35','13:40','14:25'],'IV':['14:35','15:35',null,null],'V':['15:45','16:45',null,null],'VI':['16:55','17:55',null,null]};
const BELL_TUE={'I':['08:30','09:15','09:20','10:05'],'II':['10:15','11:00','11:05','11:50'],'III':['12:20','13:05','13:10','13:55'],'IV':['14:05','15:05',null,null],'V':['15:15','16:15',null,null],'VI':['16:25','17:25',null,null]};

// ‚ïê‚ïê OLE2 –ü–ê–†–°–ï–† ‚ïê‚ïê
function u32(buf,off){return new DataView(buf instanceof Uint8Array?buf.buffer:buf,buf instanceof Uint8Array?buf.byteOffset:0).getUint32(off,true)}
function u16(buf,off){return new DataView(buf instanceof Uint8Array?buf.buffer:buf,buf instanceof Uint8Array?buf.byteOffset:0).getUint16(off,true)}

function ole2Text(ab){
  const sig=[0xD0,0xCF,0x11,0xE0,0xA1,0xB1,0x1A,0xE1];
  if(ab.byteLength<512)return'';
  const arr=new Uint8Array(ab);
  for(let i=0;i<8;i++)if(arr[i]!==sig[i])return'';
  const ss=Math.pow(2,u16(ab,30));
  const difat=[];
  for(let i=0;i<Math.min(109,u32(ab,44));i++){
    const v=u32(ab,76+i*4);if(v>=0xFFFFFFFC)break;difat.push(v);
  }
  const fat=[];
  for(const sn of difat){
    const off=512+sn*ss;
    for(let i=0;i<ss/4;i++){const p=off+i*4;if(p+4<=ab.byteLength)fat.push(u32(ab,p));}
  }
  function rd(sec,maxSz){
    const chunks=[];let total=0;const vis=new Set();
    while(sec!==0xFFFFFFFE&&sec!==0xFFFFFFFF&&!vis.has(sec)){
      vis.add(sec);const off=512+sec*ss;if(off>=ab.byteLength)break;
      const len=Math.min(ss,ab.byteLength-off);chunks.push(new Uint8Array(ab,off,len));total+=len;
      if(maxSz&&total>=maxSz)break;if(sec>=fat.length)break;sec=fat[sec];
    }
    const out=new Uint8Array(maxSz?Math.min(total,maxSz):total);let pos=0;
    for(const c of chunks){const take=Math.min(c.length,out.length-pos);out.set(c.slice(0,take),pos);pos+=take;if(pos>=out.length)break;}
    return out;
  }
  const dd=rd(u32(ab,48));
  let ws=0,wz=0;
  for(let i=0;i<Math.floor(dd.length/128);i++){
    const e=dd.slice(i*128,(i+1)*128);if(e.length<128)break;
    const nl=e[64]|e[65]<<8;
    const nm=nl>=2?new TextDecoder('utf-16le').decode(e.slice(0,nl-2)):'';
    if(nm==='WordDocument'){
      const dv=new DataView(dd.buffer,dd.byteOffset+i*128);
      ws=dv.getUint32(116,true);wz=dv.getUint32(120,true);break;
    }
  }
  if(!wz)return'';
  const wsd=rd(ws,wz);if(wsd.length<32)return'';
  const dv=new DataView(wsd.buffer,wsd.byteOffset);
  const fc=dv.getUint32(24,true),cc=dv.getUint32(28,true);
  if(fc>=wsd.length)return'';
  return new TextDecoder('utf-16le').decode(wsd.slice(fc,fc+cc*2));
}
function getCells(ab){
  const t=ole2Text(ab);if(!t)return[];
  return t.split('\x07').map(c=>c.replace(/\r/g,'\n').trim());
}
const GRP=/^[–ê-–Ø–ÅA-Z0-9]{1,5}[\-]?\d[\-]\d{2}$/u;
const ROM=/^(I{1,3}V?|VI{0,3}|IV)$/;
const HDR=/–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π/i;
function norm(s){return s.trim().toUpperCase().replace(/[\s\-\.]/g,'')}
function detectGroups(ab){
  const seen={};
  for(const c of getCells(ab)){const t=c.trim();if(GRP.test(t)){const k=norm(t);if(!seen[k])seen[k]=t;}}
  return Object.values(seen).sort();
}
function parseDoc(ab,group){
  const cells=getCells(ab),tn=norm(group),labels=[];
  cells.forEach((c,i)=>{if(HDR.test(c))labels.push(i);});
  if(!labels.length)return{sched:[],hdr:''};
  labels.push(cells.length);
  for(let bi=0;bi<labels.length-1;bi++){
    let li=labels[bi],nx=labels[bi+1],gs=li+1;
    while(gs<nx&&!GRP.test(cells[gs]))gs++;
    if(gs>=nx)continue;
    let ge=gs;while(ge<nx&&GRP.test(cells[ge]))ge++;
    const fi=[...Array(ge-gs).keys()].map(j=>gs+j).find(i=>norm(cells[i])===tn);
    if(fi===undefined)continue;
    const off=fi-li;
    const hdr=cells[li].split('\n').find(l=>HDR.test(l))?.trim()||'';
    const sched=[],seen=new Set();
    for(let ri=ge;ri<nx;ri++){
      const c=cells[ri];
      if(ROM.test(c)&&!seen.has(c)){seen.add(c);const li2=ri+off;sched.push([c,li2<cells.length?cells[li2].trim():''|'']);}
    }
    return{sched,hdr};
  }
  return{sched:[],hdr:''};
}

// ‚ïê‚ïê –Ø–ù–î–ï–ö–° –î–ò–°–ö (—Å –ø–µ—Ä–µ–±–æ—Ä–æ–º CORS –ø—Ä–æ–∫—Å–∏) ‚ïê‚ïê
const YADISK='https://cloud-api.yandex.net/v1/disk/public/resources';
const PROXIES=['','https://corsproxy.io/?url=','https://api.allorigins.win/raw?url='];
let activeProxy='';let proxyFound=false;

async function yadGet(path,params){
  const qs=new URLSearchParams(params).toString();
  const raw=`https://cloud-api.yandex.net${path}?${qs}`;
  async function tryProxy(p){
    const url=p?p+encodeURIComponent(raw):raw;
    const r=await fetch(url,{signal:AbortSignal.timeout(15000)});
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    return r.json();
  }
  if(proxyFound)return tryProxy(activeProxy);
  for(const p of PROXIES){
    try{const d=await tryProxy(p);activeProxy=p;proxyFound=true;
      document.getElementById('proxy-status').textContent=p?`–ü—Ä–æ–∫—Å–∏: ${p.split('?')[0]}`:'–ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ';
      return d;}catch(e){continue;}
  }
  throw new Error('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ø–Ω–¥–µ–∫—Å API');
}
async function yadDownload(rawUrl){
  for(const p of PROXIES){
    try{
      const url=p?p+encodeURIComponent(rawUrl):rawUrl;
      const r=await fetch(url,{signal:AbortSignal.timeout(60000)});
      if(!r.ok)throw new Error(`HTTP ${r.status}`);
      return r.arrayBuffer();
    }catch(e){continue;}
  }
  throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª');
}

// ‚ïê‚ïê –°–û–°–¢–û–Ø–ù–ò–ï ‚ïê‚ïê
const S={url:'',files:[],selectedFile:null,lastGroup:'',theme:'orange',saveUrl:true};
const FILE_CACHE={};
let allGroups=[];

function loadLocal(){
  try{
    const d=JSON.parse(localStorage.getItem('sched')||'{}');
    S.lastGroup=d.group||'';S.theme=d.theme||'orange';S.saveUrl=d.saveUrl!==false;
    if(S.saveUrl&&d.url){S.url=d.url;document.getElementById('url-input').value=S.url;}
  }catch(e){}
}
function saveLocal(){
  localStorage.setItem('sched',JSON.stringify({group:S.lastGroup,theme:S.theme,saveUrl:S.saveUrl,url:S.saveUrl?S.url:''}));
}

// ‚ïê‚ïê –¢–ï–ú–´ ‚ïê‚ïê
function applyTheme(key){
  const t=THEMES[key]||THEMES['orange'];
  Object.entries(t.vars).forEach(([k,v])=>document.documentElement.style.setProperty(k,v));
  S.theme=key;saveLocal();renderThemeGrid();
}
function renderThemeGrid(){
  const g=document.getElementById('theme-grid');g.innerHTML='';
  Object.entries(THEMES).forEach(([key,t])=>{
    const c=document.createElement('div');c.className='theme-card'+(S.theme===key?' selected':'');
    c.innerHTML=`<div class="theme-swatch">${t.sw.map(c=>`<div class="swatch" style="background:${c}"></div>`).join('')}</div><div>${t.name}</div>`;
    c.onclick=()=>applyTheme(key);g.appendChild(c);
  });
}

// ‚ïê‚ïê –ù–ê–í–ò–ì–ê–¶–ò–Ø ‚ïê‚ïê
let cur='s-home';
function showScreen(id,dir='forward'){
  if(id===cur)return;
  const prev=document.getElementById(cur),next=document.getElementById(id);
  prev.classList.add(dir==='back'?'exit-right':'exit-left');prev.classList.remove('active');
  setTimeout(()=>prev.classList.remove('exit-left','exit-right'),300);
  next.classList.add('active');cur=id;
}
function goHome(){showScreen('s-home','back');updateNavActive('nav-home');updateLastGroupBtn();}
function navTo(id,navId){showScreen(id);updateNavActive(navId);}
function updateNavActive(aid){['nav-home','nav-bells','nav-settings'].forEach(id=>document.getElementById(id)?.classList.toggle('active',id===aid));}

// ‚ïê‚ïê –ü–û–°–õ–ï–î–ù–Ø–Ø –ì–†–£–ü–ü–ê ‚ïê‚ïê
function updateLastGroupBtn(){
  const wrap=document.getElementById('last-group-wrap'),btn=document.getElementById('last-group-btn');
  if(S.lastGroup){btn.textContent=S.lastGroup;wrap.classList.remove('hidden');}
  else wrap.classList.add('hidden');
}
async function jumpToLastGroup(){
  if(!S.selectedFile){toast('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–∞–π–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è');return;}
  await loadSchedule(S.lastGroup);
}

// ‚ïê‚ïê –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–û–í ‚ïê‚ïê
async function loadFiles(){
  const url=document.getElementById('url-input').value.trim();
  if(!url){toast('–í–≤–µ–¥–∏ —Å—Å—ã–ª–∫—É');return;}
  S.url=url;if(S.saveUrl)saveLocal();
  setStatus('home-status','‚è≥ –ó–∞–≥—Ä—É–∂–∞—é...');setBar('home-bar',30);
  try{
    const data=await yadGet('/v1/disk/public/resources',{public_key:url,limit:100});
    S.files=(data._embedded?.items||[]).filter(i=>i.type==='file'&&/\.(doc|docx)$/i.test(i.name))
      .map(i=>({name:i.name,path:i.path||'',size:i.size||0}));
    setBar('home-bar',100);setStatus('home-status',`–ù–∞–π–¥–µ–Ω–æ: ${S.files.length} —Ñ–∞–π–ª–æ–≤`);
    setTimeout(()=>setBar('home-bar',0),800);renderFileList();
  }catch(e){setBar('home-bar',0);setStatus('home-status','‚ùå '+e.message);}
}
function renderFileList(){
  const list=document.getElementById('file-list');list.innerHTML='';
  S.files.forEach(f=>{
    const item=document.createElement('div');
    item.className='list-item'+(S.selectedFile?.name===f.name?' selected':'');
    item.innerHTML=`<span class="item-name">${f.name}</span><span class="item-arrow">‚Ä∫</span>`;
    item.onclick=()=>{S.selectedFile=f;renderFileList();toast('–í—ã–±—Ä–∞–Ω: '+f.name);};
    list.appendChild(item);
  });
  document.getElementById('file-section').classList.remove('hidden');
}

// ‚ïê‚ïê –ü–û–õ–£–ß–ò–¢–¨ –ë–£–§–ï–† –§–ê–ô–õ–ê (–∫–µ—à) ‚ïê‚ïê
async function getFileBuf(){
  const key=S.selectedFile.path||S.selectedFile.name;
  if(FILE_CACHE[key])return FILE_CACHE[key];
  const dl=await yadGet('/v1/disk/public/resources/download',{public_key:S.url,path:S.selectedFile.path});
  const buf=await yadDownload(dl.href);
  FILE_CACHE[key]=buf;return buf;
}

// ‚ïê‚ïê –≠–ö–†–ê–ù –ì–†–£–ü–ü ‚ïê‚ïê
async function goToGroups(){
  if(!S.selectedFile){toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª');return;}
  showScreen('s-groups');
  document.getElementById('groups-title').textContent=S.selectedFile.name;
  document.getElementById('group-search').value='';
  document.getElementById('group-list').innerHTML='';
  setStatus('groups-status','‚è≥ –°–∫–∞—á–∏–≤–∞—é...');setBar('groups-bar',20);
  try{
    const buf=await getFileBuf();
    allGroups=detectGroups(buf);
    setBar('groups-bar',100);
    setStatus('groups-status',`${allGroups.length} –≥—Ä—É–ø–ø`);
    setTimeout(()=>setBar('groups-bar',0),800);
    renderGroupList(allGroups);
  }catch(e){setBar('groups-bar',0);setStatus('groups-status','‚ùå '+e.message);}
}
function renderGroupList(groups){
  const list=document.getElementById('group-list');list.innerHTML='';
  groups.forEach(g=>{
    const item=document.createElement('div');
    item.className='list-item'+(S.lastGroup===g?' selected':'');
    item.innerHTML=`<span class="item-name">${g}</span><span class="item-arrow">‚Ä∫</span>`;
    item.onclick=()=>loadSchedule(g);list.appendChild(item);
  });
}
function filterGroups(q){
  const f=q.trim().toUpperCase();
  renderGroupList(f?allGroups.filter(g=>g.toUpperCase().includes(f)):allGroups);
}

// ‚ïê‚ïê –†–ê–°–ü–ò–°–ê–ù–ò–ï ‚ïê‚ïê
async function loadSchedule(group){
  if(!S.selectedFile){toast('–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª');return;}
  showScreen('s-schedule');
  S.lastGroup=group;saveLocal();updateLastGroupBtn();
  document.getElementById('sched-group-name').textContent=group;
  document.getElementById('sched-date').textContent='‚è≥';
  document.getElementById('sched-body').innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...</div>';
  try{
    const buf=await getFileBuf();
    const{sched,hdr}=parseDoc(buf,group);
    if(!sched.length)throw new Error(`–ì—Ä—É–ø–ø–∞ "${group}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
    renderSchedule(group,hdr,sched,S.selectedFile.name);
  }catch(e){
    document.getElementById('sched-body').innerHTML=`<div style="text-align:center;padding:40px;color:var(--danger)">‚ùå ${e.message}</div>`;
  }
}
function renderSchedule(group,hdr,sched,filename){
  document.getElementById('sched-group-name').textContent=group;
  document.getElementById('sched-date').textContent=hdr.replace('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π –Ω–∞ ','').trim()||'';
  const isMon=filename.toUpperCase().includes('–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö');
  const bell=isMon?BELL_MON:BELL_TUE;
  const now=new Date(),nowMin=now.getHours()*60+now.getMinutes();
  const body=document.getElementById('sched-body');body.innerHTML='';
  for(const[roman,lesson]of sched){
    const b=bell[roman];
    let isNow=false;
    if(b&&b[0]){const[sh,sm]=b[0].split(':').map(Number);const e=b[1]?b[1].split(':').map(Number):[sh+1,sm];isNow=nowMin>=sh*60+sm&&nowMin<=e[0]*60+e[1];}
    const lines=lesson?lesson.split('\n').map(l=>l.trim()).filter(Boolean):[];
    const isEmpty=!lines.length;
    const card=document.createElement('div');
    card.className='pair-card'+(isEmpty?'':' has-subject')+(isNow?' is-now':'');
    const nowBadge=isNow?'<span class="now-badge">—Å–µ–π—á–∞—Å</span>':'';
    let timesHtml='';
    if(b){
      const[s1,e1,s2,e2]=b;
      timesHtml=`<div class="pair-times">
        <div class="pair-time-row"><span class="pair-time-val">${s1} ‚Äì ${e1}</span><span class="pair-time-tag">${s2?'1 —É—Ä–æ–∫':'60 –º–∏–Ω'}</span></div>
        ${s2?`<div class="pair-time-row"><span class="pair-time-val">${s2} ‚Äì ${e2}</span><span class="pair-time-tag">2 —É—Ä–æ–∫</span></div>`:''}
      </div>`;
    }
    card.innerHTML=`
      <div class="pair-top">
        <div class="pair-num">${roman}</div>
        <div class="pair-subject${isEmpty?' empty':''}">${isEmpty?'–û–∫–Ω–æ':lines[0]}${nowBadge}</div>
      </div>${timesHtml}
      ${lines.length>1?`<div class="pair-details">${lines.slice(1).join('<br>')}</div>`:''}`;
    body.appendChild(card);
  }
}

// ‚ïê‚ïê –ó–í–û–ù–ö–ò ‚Äî –æ–±–µ —Å—Ç—Ä–æ–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ ‚ïê‚ïê
function renderBells(){
  const body=document.getElementById('bells-body');
  const day=(title,bell)=>{
    let h=`<div class="bell-day">${title}</div>`;
    Object.entries(bell).forEach(([num,[s1,e1,s2,e2]])=>{
      h+=`<div class="bell-card">
        <div class="bell-num">${num}</div>
        <div class="bell-slots">
          <div class="bell-slot">
            <span class="bell-slot-time">${s1} ‚Äì ${e1}</span>
            <span class="bell-slot-tag">${s2?'1 —É—Ä–æ–∫':'60 –º–∏–Ω'}</span>
          </div>
          ${s2?`<div class="bell-slot"><span class="bell-slot-time">${s2} ‚Äì ${e2}</span><span class="bell-slot-tag">2 —É—Ä–æ–∫</span></div>`:''}
        </div>
      </div>`;
    });
    return h;
  };
  body.innerHTML=day('–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',BELL_MON)+day('–í—Ç–æ—Ä–Ω–∏–∫ ‚Äì –ü—è—Ç–Ω–∏—Ü–∞',BELL_TUE);
}

// ‚ïê‚ïê –£–¢–ò–õ–ò–¢–´ ‚ïê‚ïê
function setStatus(id,t){document.getElementById(id).textContent=t}
function setBar(id,v){document.getElementById(id).style.width=v+'%'}
let _tt;
function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),2500);}
function toggleSetting(key){if(key==='saveUrl'){S.saveUrl=!S.saveUrl;document.getElementById('toggle-save-url').classList.toggle('on',S.saveUrl);saveLocal();}}

// ‚ïê‚ïê INIT ‚ïê‚ïê
loadLocal();applyTheme(S.theme);renderBells();updateLastGroupBtn();
</script>
</body>
</html>
